name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install AI review dependencies
        run: |
          npm init -y
          npm install openai @octokit/action

      - name: Run AI Review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > /tmp/review.js << 'SCRIPT_EOF'
          const { Octokit } = require("@octokit/action");
          const OpenAI = require("openai");
          const fs = require("fs");

          const octokit = new Octokit();
          const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

          async function run() {
            const eventData = JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8'));
            const prNumber = eventData.pull_request?.number || eventData.number;
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split("/");

            const { data: files } = await octokit.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: prNumber,
              per_page: 50
            });

            const code = files
              .filter(f =>
                [".html", ".css", ".js"].some(ext => f.filename.endsWith(ext))
              )
              .slice(0, 10)
              .map(f => `File: ${f.filename}\n\n${f.patch || ""}`)
              .join("\n\n");

            const prompt = `You are a computer science teacher reviewing a student's beginner-level HTML/CSS/JS assignment.

          Give helpful feedback:
          - Provide a score (from 0 to 100)
          - Point out strengths
          - Give 3â€“5 improvement suggestions
          - Mention any HTML/CSS mistakes
          - Keep the tone supportive, simple, and clear.

          Student code changes:
          ${code}`;

            const result = await client.chat.completions.create({
              model: "gpt-4o-mini",
              messages: [{ role: "user", content: prompt }]
            });

            const review = result.choices[0].message.content;

            await octokit.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: "### ðŸ¤– AI Code Review\n" + review + "\n\n> Automated feedback for learning."
            });
          }

          run().catch(err => {
            console.error(err);
            process.exit(0);
          });
          SCRIPT_EOF
          node /tmp/review.js
